<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Solving the problem - DiffSol</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="specifying_the_problem.html"><strong aria-hidden="true">1.</strong> Specifying the problem</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ode_equations.html"><strong aria-hidden="true">1.1.</strong> ODE equations</a></li><li class="chapter-item expanded "><a href="mass_matrix.html"><strong aria-hidden="true">1.2.</strong> Mass matrix</a></li><li class="chapter-item expanded "><a href="root_finding.html"><strong aria-hidden="true">1.3.</strong> Root finding</a></li><li class="chapter-item expanded "><a href="forward_sensitivity.html"><strong aria-hidden="true">1.4.</strong> Forward Sensitivity</a></li><li class="chapter-item expanded "><a href="custom_problem_structs.html"><strong aria-hidden="true">1.5.</strong> Custom Problem Structs</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="non_linear_functions.html"><strong aria-hidden="true">1.5.1.</strong> Non-linear functions</a></li><li class="chapter-item expanded "><a href="constant_functions.html"><strong aria-hidden="true">1.5.2.</strong> Constant functions</a></li><li class="chapter-item expanded "><a href="linear_functions.html"><strong aria-hidden="true">1.5.3.</strong> Linear functions</a></li><li class="chapter-item expanded "><a href="putting_it_all_together.html"><strong aria-hidden="true">1.5.4.</strong> Putting it all together</a></li></ol></li><li class="chapter-item expanded "><a href="diffsl.html"><strong aria-hidden="true">1.6.</strong> DiffSL</a></li><li class="chapter-item expanded "><a href="sparse_problems.html"><strong aria-hidden="true">1.7.</strong> Sparse problems</a></li></ol></li><li class="chapter-item expanded "><a href="choosing_a_solver.html"><strong aria-hidden="true">2.</strong> Choosing a solver</a></li><li class="chapter-item expanded "><a href="initialisation.html"><strong aria-hidden="true">3.</strong> Initialisation</a></li><li class="chapter-item expanded "><a href="solving_the_problem.html" class="active"><strong aria-hidden="true">4.</strong> Solving the problem</a></li><li class="chapter-item expanded "><a href="benchmarks.html"><strong aria-hidden="true">5.</strong> Benchmarks</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">DiffSol</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="solving-the-problem"><a class="header" href="#solving-the-problem">Solving the Problem</a></h1>
<p>Each solver implements the <a href="https://docs.rs/diffsol/latest/diffsol/ode_solver/method/trait.OdeSolverMethod.html"><code>OdeSolverMethod</code></a> trait, which provides a number of methods to solve the problem.
The fundamental method to solve the problem is the <code>step</code> method on the <code>OdeSolverMethod</code> trait, which steps the solution forward in time by a single step, with a step size chosen by the solver
in order to satisfy the error tolerances in the <code>problem</code> struct. The <code>step</code> method returns a <code>Result</code> that contains the new state of the solution if the step was successful, or an error if the step failed.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">use diffsol::OdeBuilder;
</span><span class="boring">use nalgebra::DVector;
</span><span class="boring">type M = nalgebra::DMatrix&lt;f64&gt;;
</span>use diffsol::{OdeSolverMethod, OdeSolverState, Bdf};

<span class="boring">fn main() {
</span><span class="boring">
</span><span class="boring">  let problem = OdeBuilder::new()
</span><span class="boring">    .p(vec![1.0, 10.0])
</span><span class="boring">    .build_ode::&lt;M, _, _, _&gt;(
</span><span class="boring">       |x, p, _t, y| y[0] = p[0] * x[0] * (1.0 - x[0] / p[1]),
</span><span class="boring">       |x, p, _t, v , y| y[0] = p[0] * v[0] * (1.0 - 2.0 * x[0] / p[1]),
</span><span class="boring">       |_p, _t| DVector::from_element(1, 0.1),
</span><span class="boring">    ).unwrap();
</span>let mut solver = Bdf::default();
let state = OdeSolverState::new(&amp;problem, &amp;solver).unwrap();
solver.set_problem(state, &amp;problem);
while solver.state().unwrap().t &lt; 10.0 {
    if let Err(_) = solver.step() {
        break;
    }
}
<span class="boring">}</span></code></pre></pre>
<p>The <code>step</code> method will return an error if the solver fails to converge to the solution or if the step size becomes too small.</p>
<p>Often you will want to get the solution at a specific time \(t_o\). There are two ways to do this based on your particular needs, the most lightweight way is to step the solution forward
until you are beyond \(t_o\), and then interpolate the solution back to \(t_o\) using the <code>interpolate</code> method on the <code>OdeSolverMethod</code> trait.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">use diffsol::OdeBuilder;
</span><span class="boring">use nalgebra::DVector;
</span><span class="boring">type M = nalgebra::DMatrix&lt;f64&gt;;
</span>use diffsol::{OdeSolverMethod, OdeSolverState, Bdf};

<span class="boring">fn main() {
</span><span class="boring">
</span><span class="boring">  let problem = OdeBuilder::new()
</span><span class="boring">    .p(vec![1.0, 10.0])
</span><span class="boring">    .build_ode::&lt;M, _, _, _&gt;(
</span><span class="boring">       |x, p, _t, y| y[0] = p[0] * x[0] * (1.0 - x[0] / p[1]),
</span><span class="boring">       |x, p, _t, v , y| y[0] = p[0] * v[0] * (1.0 - 2.0 * x[0] / p[1]),
</span><span class="boring">       |_p, _t| DVector::from_element(1, 0.1),
</span><span class="boring">    ).unwrap();
</span>let mut solver = Bdf::default();
let state = OdeSolverState::new(&amp;problem, &amp;solver).unwrap();
solver.set_problem(state, &amp;problem);
let t_o = 10.0;
while solver.state().unwrap().t &lt; t_o {
    solver.step().unwrap();
}
let _soln = solver.interpolate(t_o).unwrap();
<span class="boring">}</span></code></pre></pre>
<p>The second way is to use the <code>set_stop_time</code> method on the <code>OdeSolverMethod</code> trait to stop the solver at a specific time, this will override the internal time step so that the solver stops at the specified time.
Note that this can be less efficient if you wish to continue stepping forward after the specified time, as the solver will need to be re-initialised.
The enum returned by <code>step</code> will indicate when the solver has stopped at the specified time.
Once the solver has stopped at the specified time, you can get the current state of the solution using the <code>state</code> method on the solver, which returns an <a href="https://docs.rs/diffsol/latest/diffsol/ode_solver/method/struct.OdeSolverState.html"><code>OdeSolverState</code></a> struct.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">use diffsol::OdeBuilder;
</span><span class="boring">use nalgebra::DVector;
</span><span class="boring">type M = nalgebra::DMatrix&lt;f64&gt;;
</span>use diffsol::{OdeSolverMethod, OdeSolverStopReason, OdeSolverState, Bdf};

<span class="boring">fn main() {
</span><span class="boring">
</span><span class="boring">  let problem = OdeBuilder::new()
</span><span class="boring">    .p(vec![1.0, 10.0])
</span><span class="boring">    .build_ode::&lt;M, _, _, _&gt;(
</span><span class="boring">       |x, p, _t, y| y[0] = p[0] * x[0] * (1.0 - x[0] / p[1]),
</span><span class="boring">       |x, p, _t, v , y| y[0] = p[0] * v[0] * (1.0 - 2.0 * x[0] / p[1]),
</span><span class="boring">       |_p, _t| DVector::from_element(1, 0.1),
</span><span class="boring">    ).unwrap();
</span>let mut solver = Bdf::default();
let state = OdeSolverState::new(&amp;problem, &amp;solver).unwrap();
solver.set_problem(state, &amp;problem);
solver.set_stop_time(10.0).unwrap();
loop {
    match solver.step() {
        Ok(OdeSolverStopReason::InternalTimestep) =&gt; continue,
        Ok(OdeSolverStopReason::TstopReached) =&gt; break,
        Ok(OdeSolverStopReason::RootFound(_)) =&gt; panic!("Root finding not used"),
        Err(e) =&gt; panic!("Solver failed to converge: {}", e),
    }
}
let _soln = &amp;solver.state().unwrap().y;
<span class="boring">}</span></code></pre></pre>
<p>DiffSol also has two convenience functions <code>solve</code> and <code>solve_dense</code> on the <code>OdeSolverMethod</code> trait. <code>solve</code> will initialise the problem and solve the problem up to a specified time, returning the solution at all the
internal timesteps used by the solver. This function returns a tuple that contains a <code>Vec</code> of
the solution at each timestep, and a <code>Vec</code> of the times at each timestep.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">use diffsol::OdeBuilder;
</span><span class="boring">use nalgebra::DVector;
</span><span class="boring">type M = nalgebra::DMatrix&lt;f64&gt;;
</span>use diffsol::{OdeSolverMethod, Bdf};

<span class="boring">fn main() {
</span><span class="boring">  let problem = OdeBuilder::new()
</span><span class="boring">    .p(vec![1.0, 10.0])
</span><span class="boring">    .build_ode::&lt;M, _, _, _&gt;(
</span><span class="boring">       |x, p, _t, y| y[0] = p[0] * x[0] * (1.0 - x[0] / p[1]),
</span><span class="boring">       |x, p, _t, v , y| y[0] = p[0] * v[0] * (1.0 - 2.0 * x[0] / p[1]),
</span><span class="boring">       |_p, _t| DVector::from_element(1, 0.1),
</span><span class="boring">    ).unwrap();
</span>let mut solver = Bdf::default();
let (ys, ts) = solver.solve(&amp;problem, 10.0).unwrap();
<span class="boring">}</span></code></pre></pre>
<p><code>solve_dense</code> will initialise the problem and solve the problem, returning the solution at a <code>Vec</code> of times provided by the user. This function returns a <code>Vec&lt;V&gt;</code>, where <code>V</code> is the vector type used to define the problem.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">use diffsol::OdeBuilder;
</span><span class="boring">use nalgebra::DVector;
</span><span class="boring">type M = nalgebra::DMatrix&lt;f64&gt;;
</span>use diffsol::{OdeSolverMethod, Bdf};

<span class="boring">fn main() {
</span><span class="boring">  let problem = OdeBuilder::new()
</span><span class="boring">    .p(vec![1.0, 10.0])
</span><span class="boring">    .build_ode::&lt;M, _, _, _&gt;(
</span><span class="boring">       |x, p, _t, y| y[0] = p[0] * x[0] * (1.0 - x[0] / p[1]),
</span><span class="boring">       |x, p, _t, v , y| y[0] = p[0] * v[0] * (1.0 - 2.0 * x[0] / p[1]),
</span><span class="boring">       |_p, _t| DVector::from_element(1, 0.1),
</span><span class="boring">    ).unwrap();
</span>let mut solver = Bdf::default();
let times = vec![0.0, 1.0, 2.0, 3.0, 4.0, 5.0];
let _soln = solver.solve_dense(&amp;problem, &amp;times).unwrap();
<span class="boring">}</span></code></pre></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="initialisation.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="benchmarks.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="initialisation.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="benchmarks.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
